<chapter xml:id="troubleshooting"><title>illumos SMB Troubleshooting</title><itemizedlist><para>This chapter provides troubleshooting information for the illumos SMB service, illumos SMB client, and the <command>idmapd</command> service, as follows:</para><listitem><para><xref linkend="smbservertroubleshooting"/></para>
</listitem><listitem><para><xref linkend="smbclienttroubleshooting"/></para>
</listitem><listitem><para><xref linkend="idmappingtroubleshooting"/></para>
</listitem>
</itemizedlist>
<sect1 xml:id="smbservertroubleshooting"><title>illumos SMB Service Troubleshooting</title><para>The following are troubleshooting topics for the illumos SMB service.</para><sect2 xml:id="fsunexpectedbehavior"><title>File Name Case-Sensitivity Issues</title><para>Sometimes you might experience unexpected behavior when performing basic file operations. This behavior might be related to the file system being unable to handle case-insensitive operations.</para><para>SMB clients usually expect a case-insensitive file system for correct operation. The use of a ZFS file system that has been created in mixed-case or case-insensitive mode should allow you to circumvent these problems.</para><para>To create such a ZFS file system, use the following command:</para><screen># <userinput>zfs create -o casesensitivity=mixed <replaceable>fsname</replaceable></userinput></screen>
</sect2><sect2 xml:id="cannotjoinwindowsdomain"><title>Cannot Join a Windows Domain</title><para>To authenticate users from a Windows domain, the illumos SMB service must locate a domain controller, authenticate, and then add a computer account to the domain.</para><para>Users from the domain are not able to establish a connection to the illumos SMB service unless this process succeeds.</para><itemizedlist><para>The following sections describe configuration issues you might have when you cannot successfully join a Windows domain:</para><listitem><para><xref linkend="checkdnsissues"/></para>
</listitem><listitem><para><xref linkend="checktimesync"/></para>
</listitem><listitem><para><xref linkend="wrongpassword"/></para>
</listitem><listitem><para><xref linkend="insufficientpermissions"/></para>
</listitem>
</itemizedlist>
<sect3 xml:id="checkdnsissues"><title>Checking the DNS Configuration</title><para>The illumos SMB service must be running for the <command>smbadm join</command> command to succeed.</para><para>If Active Directory (AD) is configured, the illumos SMB service attempts to locate the domain controller by means of DNS. If the service cannot locate the domain controller, configure DNS properly.</para><itemizedlist><para>The following configuration issues might prevent you from configuring the illumos SMB service in domain mode:</para><listitem><para><emphasis role="strong">Missing DNS server.</emphasis> Ensure that the IP address of at least one AD DNS server is added as the name server in <filename>/etc/resolv.conf</filename>.</para><para>If your configuration is incorrect, you might see the <literal>failed to find any domain controllers</literal> error when attempting to join the domain.</para>
</listitem><listitem><para><emphasis role="strong">DNS host lookup not used.</emphasis> Ensure that DNS is used for host lookup in the <filename>/etc/nsswitch.conf</filename> file.</para>
</listitem>
</itemizedlist>
</sect3>
<sect3 xml:id="checktimesync">
<title>Checking Time Synchronization</title>
<para>You might see the following error messages, which indicate that the system clock is too far out of synchronization with that of the domain controller:</para>
<para><screen># smbadm join -y -u administrator@westsales.example.com
Enter domain password:
Joining westsales.example.com ... this may take a minute ...
failed to join domain westsales.example.com
Failed getting initial credentials. (Clock skew too great)
Please refer to the service log for more information.
#
</screen></para>
<para>This problem can be corrected by ensuring that the configuration is correct in one of these ways:</para>
<itemizedlist>
<listitem><para>
Configure both the illumos system and the DC to use the same time source (NTP server).</para>
<step><para>Synchronize the system clock on the illumos system with the system clock of the DC by running the following command on the illumos system:</para><screen># <userinput>ntpdate <replaceable>DC-hostname</replaceable></userinput></screen><para>For example, to synchronize with the DC called <literal>dc.westsales.example.com</literal>, type:</para><screen># <userinput>ntpdate dc.westsales.example.com</userinput></screen>
</step>
</listitem>
<para>For more information see "NTP server" in <xref linkend="configuredomainmodetask"/>.</para>
</itemizedlist>
</sect3>
<sect3 xml:id="wrongpassword"><title>Ensuring That You Specify the Correct Password for Your Domain User</title><para>The user that you specify on the <command>smbadm join</command> command line must have the correct password and the authority to create computer accounts. Typically, you must specify a user account that is a member of the Domain Administrators global group.</para><para>The following error message only appears if you supply the wrong password for the administrative user:</para><screen># smbadm join -y -u administrator@westsales.example.com
Enter domain password:
Joining westsales.example.com ... this may take a minute ...
failed to join domain westsales.example.com
Failed getting initial credentials. (Wrong password?)
Please refer to the service log for more information.
#</screen><para>If you attempt to join as a domain user who does not have administrative privileges, the join fails with <literal>insufficient access</literal> error messages.</para>
</sect3><sect3 xml:id="insufficientpermissions"><title>Ensuring That Your Domain User Has Sufficient Administrative Privileges</title><para>The user that you specify on the <command>smbadm join</command> command line must be a member of the Domain Administrators global group.</para><para>The following error message only appears if you attempt to join as a domain user who does not have administrative privileges. The join fails with <literal>insufficient access</literal> error messages.</para><screen>smbd: failed joining <replaceable>domain-name</replaceable> (UNSUCCESSFUL)</screen>
</sect3>
</sect2><sect2 xml:id="intermittentdomainconnectivity"><title>Checking Intermittent Domain Connectivity</title><sect3 xml:id="lostconnectiontodomain"><title>Checking the Domain Controller Selection</title><para>Sometimes the illumos SMB service might lose its connection to the domain controller. In such a situation, Windows users are denied access to the illumos SMB service.</para><para>The connection might be lost if the network experiences connectivity problems or if the primary domain controller fails.</para><para>The solution to any of these problems is to rejoin the Windows domain. See <xref linkend="configuredomainmodetask"/>.</para>
</sect3>
</sect2><sect2 xml:id="noisyidmapdinworkgroupmode"><title><command>idmapd</command> Unable to Contact AD When in Workgroup Mode</title><para>The <command>idmapd</command> server attempts to contact AD even if the illumos SMB service is in workgroup mode. As a result, <command>idmapd</command> issues errors.</para><para>To work around this problem, remove all rule-based mappings and ignore any errors from <command>idmapd</command> about its failure to contact AD.</para>
</sect2><sect2 xml:id="viewserverpropertysettings"><title>Viewing illumos SMB Service Property Settings</title><para>Much of the illumos SMB service configuration uses the <citerefentry><refentrytitle>sharectl</refentrytitle><manvolnum>8</manvolnum></citerefentry> command to set properties. Before you change property values, you should view the current property settings by running the <command>sharectl get smb</command> command.</para>
</sect2><sect2 xml:id="mappingchangesdonottakeeffect"><title>Changes to Windows Group Membership and to User Mapping Do Not Take Effect</title><para>Windows clients use an access token to assign user data and group membership. This token is assigned when the client connects to the SMB service. Any changes made to this token are not reflected until the next time the user connects.</para><para>To force changes to take effect immediately, the user must disconnect from the SMB service by logging out of all connected workstations.</para>
</sect2><sect2 xml:id="sharesecurity"><title>Cannot Set Share Security, All Shares Inherit the Security of the Directory Object</title><para>The security implementation of the illumos SMB service only secures files and directories. The effective security of an SMB share is <emphasis>always</emphasis> the security of the directory to which it points.</para>
</sect2><sect2 xml:id="cannotmapdrives"><title>Cannot Use SMB to Map Drives</title><para>To map a drive or to connect to a share, you must have read access to the directory to which the share points.</para><para>If the illumos SMB service is in domain mode, you must also be logged in to the domain.</para><orderedlist><para>To ensure that a user can connect to a share, do the following to check and modify permissions:</para><listitem><para>Log in to the system that is running the illumos SMB service.</para>
</listitem><listitem><para>Become superuser.</para>
</listitem><listitem><para>Obtain the user name and group name of the owner.</para><screen># <userinput>ls -l <replaceable>pathname</replaceable></userinput></screen><para>For example, the following output indicates that the share is a directory with 750 permissions. The owner is <literal>root</literal> and the group is <literal>sys</literal>.</para><screen># <userinput>ls -ld /vol1/data</userinput>
drwxr-x---  41 root     sys         1024 Jan  2 23:19 /vol1/data</screen>
</listitem><listitem><para>Determine the permissions necessary for the user to access the directory.</para>
</listitem><listitem><para>Use the <command>chmod</command> command to change the permissions of the directory.</para>
</listitem>
</orderedlist>
</sect2><sect2 xml:id="cannotseesecuritytab"><title>Cannot See the Security Tab From Windows Clients</title><para>Some Windows clients do not show the security tab unless you have permission to view or change security.</para><para>For information about how to view and modify share permissions, see <xref linkend="cannotmapdrives"/>.</para>
</sect2><sect2 xml:id="smbdisconnectsfrommssqlserver"><title>Microsoft Access or SQL Server Sessions Time Out After a Period of Inactivity</title><para>Applications can send SMB echo requests periodically to keep idle sessions open or to reconnect, as required, if a session times out due to inactivity. If an application appears unable to deal with an idle session timeout, the SMB service <literal>keep_alive</literal> property can be set to 0 to disable the session inactivity timer.</para><screen># <userinput>sharectl set -p keep_alive=0 smb</userinput></screen>
</sect2><sect2 xml:id="cannotaddlocalgroupstoacl"><title>Cannot Add Windows Local Groups to Access Control List</title><para>Windows local groups cannot be used to assign security on remote systems. A local group can only be used on the individual computer on which it is created. A local group is not stored in the domain SAM database.</para><para>Windows domain controllers are an exception to this behavior. Domain controllers share a set of local groups that can only be shared with other domain controllers. To make security assignments to the illumos SMB service, use global groups.</para><para>The illumos SMB service has its own set of local groups that are provided for Windows compatibility purposes. These local groups permit a limited set of privileges, and they can also be used for security assignments to individual files and folders.</para><note><para>Windows domain local groups are not supported.</para>
</note>
</sect2><sect2 xml:id="sambacannotbindports"><title>Samba or SMB Service Cannot Bind Various Ports</title><para>You will see errors if you attempt to run both the Samba service, <literal>svc:/network/samba:default</literal>, and the illumos SMB service, <literal>svc:/network/smb/server:default</literal>, simultaneously.</para><para>The Samba and illumos SMB services are mutually exclusive because they both attempt to listen on the same ports. Only one service should be enabled at any time.</para><itemizedlist><para>To disable either the Samba or illumos SMB service, do one of the following:</para><listitem><para><emphasis role="strong">Disable the Samba service.</emphasis> Use the <command>svcadm disable svc:/network/samba</command> command.</para>
</listitem><listitem><para><emphasis role="strong">Disable the illumos SMB service.</emphasis> Use the <command>svcadm disable smb/server</command> command.</para>
</listitem>
</itemizedlist>
</sect2><sect2 xml:id="invalidpassworderrors"><title><literal>invalid password</literal> Errors Appear When Mapping a Drive or Browsing Computers in the Workgroup</title><para>When you map a drive or browse computers in your workgroup, you might see <literal>invalid password</literal> errors. If you see these errors, check to see that the <filename>/var/smb/smbpasswd</filename> file includes information for the appropriate users.</para><para>Also, ensure that the <literal>pam_smb_passwd.so.1</literal> entry is in the <filename>/etc/pam.conf</filename> file and that you use the <command>passwd</command> command to set your password.</para><para>For more information, see <xref linkend="configureworkgroupmodetask"/>.</para>
</sect2><sect2 xml:id="aclinheritanceissues"><title>Access Control List Inheritance Issues</title><para>Access control list (ACL) behavior differs between Windows systems and ZFS on illumos systems. You might experience Windows ACL inheritance problems because of the access control entry (ACE) ordering used by the default ZFS ACL.</para><para>The default ZFS ACL is designed to comply with POSIX, which results in the interleaving of <literal>allow</literal> and <literal>deny</literal> ACEs. Windows expects all <literal>deny</literal> ACEs to precede all <literal>allow</literal> ACEs.</para><para>You can override the default ZFS behavior by changing the ACL on the root directory to provide the equivalent of <literal>Everyone:FullControl</literal> as follows:</para><screen># <userinput>chmod 777 /<replaceable>pool-name</replaceable></userinput>
# <userinput>chmod A=everyone@:rwxpdDaARWcCos:fd:allow /<replaceable>pool</replaceable>/<replaceable>fs-name</replaceable></userinput></screen><para>For information about the <command>chmod</command> options, see the <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry> man page.</para><para>You can verify the ACL by viewing it on Windows or by running the following command on an illumos system:</para><screen># <userinput>ls -V -d /<replaceable>pool-name</replaceable>/<replaceable>fs-name</replaceable></userinput></screen><para>You can apply this ACL recursively to all subdirectories and files for existing file systems from Windows or from the illumos OS.</para><para>If you apply the ACL when the file system is first created, the ACL will be propagated according to the normal inheritance rules.</para><para>If a directory has a default ZFS ACL, when a file or folder is created under this directory from Windows, it has two ACEs: one for the owner and one for SYSTEM. To change this behavior, update the root directory's ACL by running the <command>chmod</command> commands shown previously.</para>
</sect2>
</sect1>
<sect1 xml:id="smbclienttroubleshooting"><title>illumos SMB Client Troubleshooting</title><sect2 xml:id="viewclientpropertysettings"><title>Viewing illumos SMB Client Property Settings</title><para>The illumos SMB client configuration uses the <command>sharectl</command> command to set properties. Before you change property values, view the current property settings by running the <command>sharectl get smbfs</command> command.</para>
</sect2><sect2 xml:id="accessdeniedtoserver"><title><literal>Access Denied</literal> Message When Accessing a Server</title><para>You get an <literal>Access Denied</literal> error when attempting to access or view SMB shares from a server. This problem might occur because the password you supplied is wrong or the SMB server is part of a domain.</para><para>If the SMB server is part of a domain, you must provide the domain name for the <command>smbutil view</command> or <command>mount</command> command. Otherwise, the server assumes that you are attempting to authenticate a local user, and the authentication process fails.</para><para>For example, if the server <literal>solarsystem</literal> is in the <literal>MYDOMAIN</literal> domain, the following commands would be appropriate to view and access SMB shares as user <literal>cal</literal>:</para><screen># <userinput>smbutil view "//MYDOMAIN;cal@solarsystem"</userinput>
# <userinput>mount -F smbfs "//MYDOMAIN;cal@solarsystem/tmp" /mnt</userinput></screen><para>To obtain the domain name, use the <command>smbutil status <replaceable>server</replaceable></command> command, which sends a NetBIOS query to the specified server:</para><screen># <userinput>smbutil status solarsystem</userinput>
Workgroup: MYDOMAIN
Server: SOLARSYSTEM</screen>
</sect2><sect2 xml:id="cannotviewmountshare"><title>Cannot View or Mount SMB Shares</title><para>If you are unable to view or mount SMB shares, use the <command>smbutil view -A //<replaceable>server</replaceable></command> command. The <option>A</option> option gives anonymous access to the server if the server permits such access.</para>
</sect2><sect2 xml:id="cannotmountsharereguser"><title>Cannot Mount SMB Shares as a Regular User</title><para>You might see the following error message when you attempt to mount an SMB share as a regular user on a mount point that you own:</para><screen>$ <userinput>mount -F smbfs //<replaceable>username</replaceable>@<replaceable>server-name</replaceable>/<replaceable>share-name</replaceable> <replaceable>mount-point</replaceable></userinput>
mount: mount_smbfs: <replaceable>mount-point</replaceable>: Not owner</screen><para>Verify that you have the following entries in your <filename>/etc/security/exec_attr</filename> file:</para><screen>Basic Solaris User:solaris:cmd:::/usr/lib/fs/smbfs/mount:privs=sys_mount
Basic Solaris User:solaris:cmd:::/usr/lib/fs/smbfs/umount:privs=sys_mount</screen><para>These entries in the <filename>/etc/security/exec_attr</filename> file enable you to mount and unmount SMB shares on mount points that you own as a regular user.</para>
</sect2><sect2 xml:id="filechangedasreadwarningsfromtar"><title><command>tar</command> and <command>gtar</command> Issues <literal>file changed as we read it</literal> Warnings</title><itemizedlist><para>You might see the <literal>file changed as we read it</literal> warning in the following situations:</para><listitem><para>When you use the illumos SMB client to mount an SMB share, and use the <command>gtar</command> utility to write the share to a tape</para>
</listitem><listitem><para>When you use the illumos SMB client to mount an SMB share, and use the <command>tar</command> utility checks file attributes after setting them</para>
</listitem>
</itemizedlist><para>Other than these warnings, the <command>tar</command> and <command>gtar</command> operations succeed as expected.</para><para>You can ignore these warnings.</para><note><para><literal>smbfs</literal> ignores calls to set any file or directory attributes, as those have no direct representation in SMB. Also, <literal>smbfs</literal> does not support the &ldquo;UNIX extensions&rdquo; that would permit the storing of attributes with some servers.</para>
</note>
</sect2>
</sect1><sect1 xml:id="idmappingtroubleshooting"><title>Identity Mapping Troubleshooting</title><sect2 xml:id="viewidmappropertysettings"><title>Viewing Identity Mapping Service Property Settings</title><para>The identity mapping service uses the <citerefentry><refentrytitle>svccfg</refentrytitle><manvolnum>8</manvolnum></citerefentry> command to set properties. Before you change property values, you should view the current property settings.</para><itemizedlist><para>To view configuration properties related to the <command>idmap</command> service, run one of the following commands:</para><listitem><para><command># svccfg -s idmap listprop "config/*"</command></para>
</listitem><listitem><para><command># svcprop -p config svc:/system/idmap</command></para>
</listitem>
</itemizedlist><itemizedlist><para>To view all properties related to the <command>idmap</command> service, run one of the following commands:</para><listitem><para><command># svccfg -s idmap listprop</command></para>
</listitem><listitem><para><command># svcprop svc:/system/idmap</command></para>
</listitem>
</itemizedlist>
</sect2><sect2 xml:id="saveandrestorenamebasedmappings"><title>Saving and Restoring Rule-Based Mappings</title><para>You might need to back up and restore your rule-based mappings.</para><para>For more information about the <command>idmap export</command>, <command>idmap import</command>, and <command>idmap list</command> commands, see the <citerefentry><refentrytitle>idmap</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para><orderedlist><para>To <emphasis>back up</emphasis> the mappings, perform the following steps:</para><listitem><itemizedlist><para>Save your rule-based mappings in one of the following ways:</para><listitem><para>Export the mappings.</para><screen># <userinput>idmap export -f <replaceable>output-file</replaceable> <replaceable>format</replaceable></userinput></screen>
</listitem><listitem><para>List the mappings.</para><screen># <userinput>idmap list ><replaceable>output-file</replaceable></userinput></screen>
</listitem>
</itemizedlist>
</listitem><listitem><para>Disable the <command>idmap</command> service.</para><screen># <userinput>svcadm disable idmap</userinput></screen>
</listitem><listitem><para>Remove the <filename>idmap.db</filename> databases.</para><screen># <userinput>rm /var/idmap/idmap.db /var/run/idmap/idmap.db</userinput></screen>
</listitem><listitem><para>Reboot the system.</para>
</listitem>
</orderedlist><itemizedlist><para>To <emphasis>restore</emphasis> the mappings, use the mapping output you saved during the backup procedure. Do one of the following to restore based on your backup method:</para><listitem><para><emphasis role="strong">Use the</emphasis> <command>idmap import</command> <emphasis role="strong">command.</emphasis></para><screen># <userinput>idmap import -f <replaceable>input-file</replaceable> <replaceable>format</replaceable></userinput></screen>
</listitem><listitem><para><emphasis role="strong">Use the</emphasis> <command>idmap list</command> <emphasis role="strong">command.</emphasis></para><para>Run <replaceable>output-file</replaceable> as a shell script.</para><screen># <userinput>sh ./<replaceable>output-file</replaceable></userinput></screen>
</listitem>
</itemizedlist>
</sect2><sect2 xml:id="detailedviewofmappings"><title>Viewing Details About Mappings</title><para>If you encounter unexpected mapping results, use the <command>idmap dump</command> and <command>idmap show</command> commands to gather data. Each command has a <option>v</option> option that produces detailed information about mappings.</para><para>For more information, see <xref linkend="dumpmappingtask"/> and <xref linkend="showmappingtask"/>.</para>
</sect2>
</sect1>
</chapter>
