<chapter xml:id="smboverview"><title>Windows Interoperability (Overview)</title><para>This administration guide provides the information needed to integrate an illumos <firstterm>Server Message Block (SMB)</firstterm> server into an existing <trademark>Windows</trademark> environment and also describes the illumos SMB client, which enables you to mount SMB shares on illumos systems.</para><para>Windows clients can access SMB shares from the illumos SMB service as if they were made available from a Windows server. This guide focuses only on the information required to integrate the illumos SMB service and how to use the illumos SMB client. Windows topics are only covered when those topics affect the integration of the illumos SMB service into the Windows environment.</para><itemizedlist><para>This chapter covers the following topics:
</para><listitem><para><xref linkend="smbenvironmentoverview"/></para>
</listitem><listitem><para><xref linkend="processoverview"/></para>
</listitem><listitem><para><xref linkend="smbcmdsdaemonsfiles"/></para>
</listitem><listitem><para><xref linkend="namingdirectoryservices"/></para>
</listitem><listitem><para><xref linkend="smbshares"/></para>
</listitem><listitem><para><xref linkend="localsmbgroupsusers"/></para>
</listitem>
</itemizedlist><note><para>The Server Message Block (SMB) protocol allows SMB clients to access files and resources on SMB servers. SMB is the predominant file-sharing protocol in Windows environments. In this docuemnt, the term SMB is used to refer to all versions of the SMB protocol.
</para>
</note>
<sect1 xml:id="smbenvironmentoverview"><title>The illumos SMB Service</title><para>The illumos Operating System (illumos OS) provides an integrated <firstterm>SMB service</firstterm>. An illumos server can be an active participant in a Windows active directory domain and provide ubiquitous, cross-protocol file sharing through SMB and NFS to clients in their native dialect.</para><para>The illumos SMB service allows a native illumos system to serve files, by means of SMB <firstterm>share</firstterm>s, to SMB enabled clients, such as Windows and Mac OS systems. By virtue of the illumos SMB service, a Windows client (or other SMB client) can interoperate with the illumos SMB service as it would with a Windows server.</para><para>The illumos SMB service can operate in either workgroup mode or in domain mode. In workgroup mode, the illumos SMB service is responsible for authenticating users locally when access is requested to shared resources. This authentication process is referred to as local login. In domain mode, the illumos SMB service uses either Kerberos or "pass-through" authentication.  With pass-through authentication, the server uses NetLOGON RPC to pass authentication requests through to a domain controller.</para><para>When a user is successfully authenticated, the illumos SMB service generates an access token using the security identifiers (SIDs) that represent the user's identity and the groups of which the user is a member. When the user requests access to files or resources from the service, the access token is used to determine access to files by cross-checking the token with the access control list (ACL) or permissions on files and resources. illumos OS credentials have been enhanced to fully support Windows-style SIDs. In addition, file systems, such as ZFS, support Windows-style ACLs and access checking.</para><para>The illumos OS is unique in that it can manage user identities simultaneously by using both traditional Unix-style UIDs and GIDs and Windows-style SIDs. When a user is authenticated through the SMB service, the user's Windows identity is mapped to the appropriate <trademark>UNIX</trademark> identity by the <command>idmap</command> identity mapping service. If an existing UNIX identity exists, that identity is used. Otherwise, a temporary identity is generated using <firstterm>ephemeral</firstterm> UIDs and GIDs, as required. Ephemeral IDs are valid only within each illumos OS instance and only until the system is rebooted. These IDs are never stored on disk or transmitted over the network. When an ACL is stored on disk through the SMB service, the SIDs are used to generate the access control entries. Unix utilities, such as <command>ls</command> and <command>chmod</command>, support ACL management.</para><para>For more information about how the illumos OS manages user identities, see <xref linkend="idmappingtasks"/>.</para><para>The following diagram shows how an illumos file server can operate simultaneously with both Unix name services and <firstterm>Windows domain</firstterm>s. The <firstterm>Windows domain controller</firstterm> provides SMB authentication and naming services for SMB clients and servers, while the Unix name servers provide naming services for NFS clients and servers. Note that a Windows domain controller can also act as a Unix name service.</para>
<figure xml:id="smbenvfigure">
<title>illumos SMB Environment</title>
<mediaobject>
  <imageobject><imagedata fileref="figures/illumosSMBDiagram" scale="75" /></imageobject>
  <textobject><simpara>Diagram showing the components and interactions in an illumos SMB environment.</simpara></textobject>
</mediaobject>
</figure>
<itemizedlist><para>The illumos services described in this book include the following components:</para><listitem><para><xref linkend="smbserver"/></para>
</listitem><listitem><para><xref linkend="smbclient"/></para>
</listitem><listitem><para><xref linkend="idmappingservice"/></para>
</listitem>
</itemizedlist><sect2 xml:id="smbserver"><title>illumos SMB Service</title><note><para>The <firstterm>Samba</firstterm> and SMB services cannot be used simultaneously on a single illumos system. The Samba service must be disabled in order to run the illumos SMB service. For more information, see <xref linkend="disablesambatask"/>.</para>
</note><para>For a high-level overview of configuring the illumos SMB service, see <xref linkend="processoverview"/>.
<!-- XXX better way to ref. chapter numbers? -->
For information about configuring the service, see Chapter&nbsp;3, <xref linkend="smbservertasks"/>.
For more information about the illumos SMB service, see the
<citerefentry><refentrytitle>smbadm</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
<citerefentry><refentrytitle>smbd</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
<citerefentry><refentrytitle>smbstat</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
<citerefentry><refentrytitle>smb</refentrytitle><manvolnum>5</manvolnum></citerefentry>,
<citerefentry><refentrytitle>smbautohome</refentrytitle><manvolnum>5</manvolnum></citerefentry>,
and <citerefentry><refentrytitle>pam_smb_passwd</refentrytitle><manvolnum>7</manvolnum></citerefentry> man pages.</para><itemizedlist><para>The SMB features offered by the illumos service depend on the file system being shared. To fully support the illumos SMB service, a file system should support the following features:</para><listitem><para>If the file system supports the <literal>archive</literal>, <literal>hidden</literal>, <literal>read-only</literal>, and <literal>system</literal> attributes, these attributes are made available as the DOS attributes available on Windows systems. ZFS supports these attributes.</para>
</listitem><listitem><para>If the file system supports illumos extended attributes, they are made available as NTFS alternate data streams (also known as "named streams").</para>
</listitem><listitem><para>The case-sensitivity capabilities of the file system are made available to SMB clients. To support both Windows-style access and POSIX access, a file system should support mixed-mode, which is simultaneous support for case-sensitive and case-insensitive name operations.</para><para>The illumos OS supports both the NFS and SMB protocols, which have different expectations regarding case behavior. For instance, Windows clients typically expect case-insensitive behavior while local applications and NFS clients typically expect case-sensitive behavior. The ZFS file system supports three case modes: case-sensitive, case-insensitive, and mixed. The ZFS file system can indicate case conflicts when in mixed mode. Mixed mode is recommended for maximum multi-protocol compatibility.</para>
</listitem><listitem><para>To provide full Windows <firstterm>access control list (ACL)</firstterm> support, file systems should be able to store SIDs and they should at least support NFSv4 ACLs.</para>
</listitem>
</itemizedlist><para>For information about the supported features of the UFS and ZFS file systems, see the <citerefentry><refentrytitle>ufs</refentrytitle><manvolnum>4FS</manvolnum></citerefentry> man page and the <link xl:href="https://www.illumos.org/books/zfs-admin"><citetitle remap="book">ZFS Administration Guide</citetitle></link>, respectively.</para><para>For information about how to access SMB shares from your client, refer to the client documentation.</para>
</sect2><sect2 xml:id="smbclient"><title>illumos SMB Client</title><para>The SMB protocol is the native file-sharing protocol used by Windows and Mac OS systems. Samba implements the SMB protocol for UNIX and Linux systems. The illumos SMB client is a virtual file system that provides access to files and directories from the SMB service.</para><para>By using the illumos SMB client, a user can mount remote SMB shares (directories) on their illumos system to get read-write access to previously inaccessible files. The illumos SMB client enables an unprivileged user to mount and unmount shares on directories he owns.</para><para>For more information about how to use the illumos SMB client to access shares, see Chapter&nbsp;4, <xref linkend="smbclienttasks"/>, and the <citerefentry><refentrytitle>smbutil</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>mount_smbfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>nsmbrc</refentrytitle><manvolnum>5</manvolnum></citerefentry>, and <citerefentry><refentrytitle>pam_smbfs_login</refentrytitle><manvolnum>7</manvolnum></citerefentry> man pages.</para>
</sect2><sect2 xml:id="idmappingservice"><title>Identity Mapping Service</title><para>The illumos OS includes an identity mapping service that enables you to map identities between Unix and Windows systems using:</para><itemizedlist><para>This identity mapping service supports the following types of mappings between Windows security identities (SIDs) and Unix user IDs and group IDs (UIDs and GIDs):</para><listitem><para><emphasis role="strong">Name-based mapping.</emphasis> Maps Windows and Unix users and groups by name in the following ways:</para><itemizedlist><listitem><para><emphasis role="strong">Directory-based mapping.</emphasis> Uses name mapping information that is stored in user or group objects in the Active Directory (AD) and/or the native LDAP directory service to map users and groups.</para>
</listitem><listitem><para><emphasis role="strong">Rule-based mapping.</emphasis> An administrator uses rules to map Windows and Unix users and groups by name.</para>
</listitem>
</itemizedlist>
</listitem><listitem><para><emphasis role="strong">Ephemeral ID mapping.</emphasis> A UID or GID is dynamically allocated as needed for every SID that is not already mapped by name. Ephemeral ID mapping is used by default.</para>
</listitem><listitem><para><emphasis role="strong">Local SID mapping.</emphasis> A non-ephemeral UID or GID is mapped to an algorithmically generated local SID.</para>
</listitem>
</itemizedlist><para>The <command>idmap</command> utility can be used to create and manage the name-based mappings and to monitor the mappings in effect.</para><para>
For more information about mapping user and group identities, see <xref linkend="mapusergroupidentities"/>. For information about how to determine your identity mapping strategy, see <xref linkend="createidmappingstrategy"/>. For instructions on how to use the <command>idmap</command> command, see <xref linkend="managedirbasedusergroupmapstm"/>, <xref linkend="manageusergroupmapstm"/>, and the <citerefentry><refentrytitle>idmap</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect2><sect2 xml:id="smbconfigpropertymanagement"><title>Managing illumos SMB Configuration Properties</title><para>The illumos SMB service and the illumos SMB client use the <command>sharectl</command> command to manage configuration properties. For descriptions of the illumos SMB service properties, see the <citerefentry><refentrytitle>sharectl</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>smb</refentrytitle><manvolnum>5</manvolnum></citerefentry> man pages. For descriptions of the illumos SMB client properties, see the <citerefentry><refentrytitle>nsmbrc</refentrytitle><manvolnum>5</manvolnum></citerefentry> man page.</para><para>The illumos SMB properties and their values are stored in the Service Management Facility (SMF). For more information about SMF, see Chapter 15, <citetitle remap="chapter">Managing Services (Overview),</citetitle> in <citetitle remap="book">System Administration Guide: Basic Administration</citetitle>.</para><para>The <command>sharectl</command> command is used throughout the configuration process to set and view properties. This command and examples of its use are described in Chapter&nbsp;3, <xref linkend="smbservertasks"/>. The <command>sharectl</command> command is also used by the illumos SMB client to configure the global environment. For more information, see Chapter&nbsp;4, <xref linkend="smbclienttasks"/>.</para>
</sect2>
</sect1><sect1 xml:id="processoverview"><title>Configuring the illumos SMB Service &ndash; Process Overview</title><para>This section describes the high-level process for configuring the illumos SMB service.</para><orderedlist><listitem><para>Determine your identity mapping strategy.</para><para>See <xref linkend="createidmappingstrategy"/>.</para>
</listitem><listitem><para>Configure the illumos SMB service as a client to the various services that are used in your environment.</para><itemizedlist>
</itemizedlist><para>Your illumos system might need to be a client of other services that are available in your environment.</para><itemizedlist><para>The following list shows these other services and points to information about how to configure your illumos system as a client of that service.</para><listitem><para>For DNS, see <citetitle remap="book">System Administration Guide: Naming and Directory Services (DNS, NIS, and LDAP)</citetitle>.</para>
</listitem><listitem><para>For Kerberos, see <citetitle remap="section">Configuring Kerberos Clients (Task Map)</citetitle> in <citetitle remap="book">System Administration Guide: Security Services</citetitle>.</para>
</listitem><listitem><para>For LDAP, see Chapter 12, <citetitle remap="chapter">Setting Up LDAP Clients (Tasks),</citetitle> in <citetitle remap="book">System Administration Guide: Naming and Directory Services (DNS, NIS, and LDAP)</citetitle>.</para>
</listitem><listitem><para>For NIS, see <citetitle remap="section">Setting Up NIS Clients</citetitle> in <citetitle remap="book">System Administration Guide: Naming and Directory Services (DNS, NIS, and LDAP)</citetitle>.</para>
</listitem><listitem><para>For NTP, see <citetitle remap="section">How to Set Up an NTP Client</citetitle> in <citetitle remap="book">System Administration Guide: Network Services</citetitle>.</para>
</listitem>
</itemizedlist>
</listitem><listitem><para>Determine whether you want the illumos SMB service to join an existing <glossterm>Windows domain</glossterm> or a <firstterm>Windows workgroup</firstterm>.</para><itemizedlist><listitem><para>To join a domain, see <xref linkend="configuredomainmodetask"/>.</para>
</listitem><listitem><para>To join a workgroup, see <xref linkend="configureworkgroupmodetask"/>.</para>
</listitem>
</itemizedlist>
</listitem><listitem><para>Define one or more SMB shares.</para><para>See <xref linkend="managingsmbsharestm"/>.</para>
</listitem>
</orderedlist>
</sect1><sect1 xml:id="smbcmdsdaemonsfiles"><title>Utilities and Files Associated With the illumos SMB Server and Client</title><itemizedlist><para>This section describes the SMB utilities and files that are used by the SMB service and client.</para><listitem><para><xref linkend="smbcommands"/></para>
</listitem><listitem><para><xref linkend="smbdaemons"/></para>
</listitem><listitem><para><xref linkend="smbfiles"/></para>
</listitem>
</itemizedlist>
<sect2 xml:id="smbcommands"><title>illumos SMB Utilities</title><itemizedlist><para>These utilities must be run as superuser or with specific privileges to be fully effective, but requests for information can be made by all users:</para><listitem><para><xref linkend="mountsmbfscommand"/></para>
</listitem><listitem><para><xref linkend="sharectlcommand"/></para>
</listitem><listitem><para><xref linkend="sharemgrcommand"/></para>
</listitem><listitem><para><xref linkend="smbadmcommand"/></para>
</listitem><listitem><para><xref linkend="smbstatcommand"/></para>
</listitem><listitem><para><xref linkend="smbutilcommand"/></para>
</listitem><listitem><para><xref linkend="umountsmbfscommand"/></para>
</listitem>
</itemizedlist><sect3 xml:id="mountsmbfscommand"><title><command>mount_smbfs</command> Command</title><para>With this command, you can attach a named SMB share to a specified mount point. The <command>mount_smbfs</command> command enables you to mount an SMB share to a directory you own without having to become superuser.</para><itemizedlist><para>For more information, see the following:</para><listitem><para><xref linkend="mountsharetask"/></para>
</listitem><listitem><para><xref linkend="setupmultiusersharetask"/></para>
</listitem><listitem><para><xref linkend="automountsharetask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>mount_smbfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="sharectlcommand"><title><command>sharectl</command> Command</title><itemizedlist><para>The <command>sharectl</command> utility is an administrative tool that enables you to configure and manage file-sharing protocols, such as SMB and NFS. You can use this command to do the following:</para><listitem><para>Set client and server operational properties</para>
</listitem><listitem><para>Display property values for a specific protocol</para>
</listitem><listitem><para>Obtain the status of a protocol</para>
</listitem>
</itemizedlist><itemizedlist><para>For procedures that use the <command>sharectl</command> utility, see the following:</para><listitem><para><xref linkend="settingupsmbtask"/></para>
</listitem><listitem><para><xref linkend="customizeglobalenvtask"/></para>
</listitem><listitem><para><xref linkend="viewglobalenvtask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>sharectl</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="sharemgrcommand"><title><command>sharemgr</command> Command</title><itemizedlist><para>The <command>sharemgr</command> utility is an administrative tool that provides an enhanced method of sharing files and performing related tasks. The <command>sharemgr</command> utility introduces the following concepts:</para><listitem><para><emphasis role="strong">Share.</emphasis> One or more files or directories in a share group.</para>
</listitem><listitem><para><emphasis role="strong">Share group.</emphasis> A container of one or more shared files or directories.</para><itemizedlist><para>Note the following:</para><listitem><para>Options for <command>sharemgr</command> are set to a share group, not to a specific file or directory. All options apply to each file and directory in the group.</para>
</listitem><listitem><para>A file or directory can only be assigned to one share group. However, you can move a file or directory from one group to another.</para>
</listitem><listitem><para>A share group can be used by multiple file system types. For example, the share group <literal>my_group</literal> could be used by NFS and ZFS and be assigned one set of options for NFS and another set of options for ZFS.</para><note><para>When a share is managed by ZFS, <command>sharemgr</command> identifies the share and lists it in a <literal>zfs</literal> share group.</para>
</note>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist><note><para>The <command>sharemgr</command> utility provides a unique way of checking the validity of a desired configuration. The <option>n</option> option allows you to test the validity of the options and properties you want to use with a specific subcommand. The test does not change your configuration. For example, if you use the <option>n</option> option with the subcommand <command>create</command>, no share group is created.</para>
</note><para>You can also use the ZFS <literal>sharesmb</literal> property to configure SMB sharing. For more information, see <xref linkend="createstaticsmbsharezfstask"/> and the <citerefentry><refentrytitle>zfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>zpool</refentrytitle><manvolnum>8</manvolnum></citerefentry> man pages.</para><itemizedlist><para>For procedures that use the <command>sharemgr</command> utility, see the following:</para><listitem><para><xref linkend="createstaticsmbsharetask"/></para>
</listitem><listitem><para><xref linkend="modifysmbsharetask"/></para>
</listitem><listitem><para><xref linkend="removesmbsharetask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>sharemgr</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="smbadmcommand"><title><command>smbadm</command> Command</title><para>You can use the <command>smbadm</command> command to manage domain membership of the illumos SMB service. For instance, you can have the illumos SMB service use domain mode or workgroup mode. The <command>smbadm</command> command also enables you to configure SMB local groups. SMB local groups can be used when Windows accounts must be members of some local groups and when Windows-style privileges must be granted. Unix local groups cannot provide these functionalities.</para><itemizedlist><para>For procedures that use the <command>smbadm</command> utility, see the following:</para><listitem><para><xref linkend="configuredomainmodetask"/></para>
</listitem><listitem><para><xref linkend="configureworkgroupmodetask"/></para>
</listitem><listitem><para><xref linkend="createsmbgrouptask"/></para>
</listitem><listitem><para><xref linkend="addmembertosmbgrouptask"/></para>
</listitem><listitem><para><xref linkend="removememberfromsmbgrouptask"/></para>
</listitem><listitem><para><xref linkend="modifysmbgroupprivstask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>smbadm</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="smbstatcommand"><title><command>smbstat</command> Command</title><para>You can use the <command>smbstat</command> command to show statistical information about the <command>smbd</command> server. By default, the <command>smbstat</command> command shows general information about the SMB service as well as dispatched SMB request counters. For more information, see the <citerefentry><refentrytitle>smbstat</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para><para>The <command>kstat</command> command can be used to report on kernel SMB statistics on a periodic basis and also to specify information about individual SMB statistics. For more information, see the <citerefentry><refentrytitle>kstat</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="smbutilcommand"><title><command>smbutil</command> Command</title><itemizedlist><para>Use the <command>smbutil</command> command to perform the following SMB client tasks:</para><listitem><para>View the shares available for mounting from a particular SMB server</para>
</listitem><listitem><para>Print a file via a "print" share on an SMB server</para>
</listitem><listitem><para>Generate a hash of a password for storing in a file such as <filename>$HOME/.nsmbrc</filename></para>
</listitem><listitem><para>Create or remove persistent passwords used to authenticate to SMB servers</para>
</listitem><listitem><para>Resolve a name to an IP address for a server that uses SMB over NetBIOS, not TCP</para>
</listitem><listitem><para>Resolve the specified server to the NetBIOS workgroup and system name</para>
</listitem>
</itemizedlist><itemizedlist><para>For procedures that use the <command>smbutil</command> utility, see the following:</para><listitem><para><xref linkend="findsharestask"/></para>
</listitem><listitem><para><xref linkend="mountsharetask"/></para>
</listitem><listitem><para><xref linkend="storepasswordtask"/></para>
</listitem><listitem><para><xref linkend="pammoduletask"/></para>
</listitem><listitem><para><xref linkend="deletepasswordtask"/></para>
</listitem><listitem><para><xref linkend="setupmultiusersharetask"/></para>
</listitem><listitem><para><xref linkend="deleteallpasswordstask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>smbutil</refentrytitle><manvolnum>1</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="umountsmbfscommand"><title><command>umount_smbfs</command> Command</title><para>With this command, you can remove a named SMB share from a mount point.</para><para>For more information, see <xref linkend="unmountsharetask"/>, and the <citerefentry><refentrytitle>mount_smbfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect3>
</sect2><sect2 xml:id="smbdaemons"><title>illumos SMB Service Daemon</title><para>The <command>smbd</command> daemon supports SMB activities on illumos systems. The <command>smbd</command> daemon provides the gateway to the various user space components that support non-file I/O SMB services. Similar to the NFS kernel service, the SMB kernel module provides SMB file I/O services directly between the network interface and the virtual file system (VFS) within the kernel. Whenever a non-file I/O request is received, such as a user authentication or an MS-RPC named pipe request, it is passed to <command>smbd</command> for processing in user space. Requests that require interaction with a domain controller via SMB "named pipes" are passed to the SMB client, which handles the outbound SMB connection management.</para><para>The <command>smbd</command> daemon depends on the <command>idmapd</command> daemon. For more information about the identity mapping service, see Chapter&nbsp;2, <xref linkend="idmappingtasks"/>, and the <citerefentry><refentrytitle>idmap</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>idmapd</refentrytitle><manvolnum>8</manvolnum></citerefentry> man pages.</para><para><command>smbd</command> is part of the <literal>svc:/network/smb/server:default</literal> service.</para><para>For more information, see the <citerefentry><refentrytitle>smbd</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page.</para>
</sect2><sect2 xml:id="smbfiles"><title>illumos SMB Files</title><itemizedlist><para>The following files support SMB activities on any computer:</para><listitem><para><filename>/etc/auto_direct</filename></para>
</listitem><listitem><para><filename>/etc/smbautohome</filename></para>
</listitem><listitem><para><filename>$HOME/.nsmbrc</filename></para>
</listitem>
</itemizedlist><sect3 xml:id="autodirectfile"><title><filename>/etc/auto_direct</filename> File</title><para>Use the <filename>/etc/auto_direct</filename> file to automatically mount an SMB share when a user accesses the mount point. To use the automount feature, you must store a persistent password for authentication to mount the share. See <xref linkend="storepasswordtask"/>.</para><para>For instructions and examples, see <xref linkend="automountsharetask"/>.</para>
</sect3><sect3 xml:id="smbautohomefile"><title><filename>/etc/smbautohome</filename> File</title><para>The <filename>/etc/smbautohome</filename> file is used to define the automatic sharing rules to be applied when a user connects to the illumos SMB service. For more information, see <xref linkend="autohomeshares"/> and the <citerefentry><refentrytitle>smbautohome</refentrytitle><manvolnum>5</manvolnum></citerefentry> man page.</para>
</sect3><sect3 xml:id="nsmbrcfile"><title><filename>$HOME/.nsmbrc</filename> File</title><para>You can use the <filename>$HOME/.nsmbrc</filename> file to override global behavior of the illumos SMB client. Global values are set in the Service Management Facility (SMF). The <filename>.nsmbrc</filename> file is used to customize the behavior of the illumos SMB client on a per-user basis.</para><para>By default, settings in the <filename>$HOME/.nsmbrc</filename> file are used unless they have security implications, in which case the stronger security setting is used.</para><itemizedlist><para>For procedures that refer to the <filename>$HOME/.nsmbrc</filename> file, see the following:</para><listitem><para><xref linkend="customizeenvtask"/></para>
</listitem><listitem><para><xref linkend="customizeglobalenvtask"/></para>
</listitem><listitem><para><xref linkend="viewglobalenvtask"/></para>
</listitem>
</itemizedlist><para>Also, see the <citerefentry><refentrytitle>nsmbrc</refentrytitle><manvolnum>5</manvolnum></citerefentry> man page.</para>
</sect3>
</sect2>
</sect1><sect1 xml:id="namingdirectoryservices"><title>Authentication, Directory, Naming, and Time Services</title><para>This section describes the various services that the illumos SMB service interoperates with as a client.</para><itemizedlist><para>The illumos SMB service interoperates with a variety of naming services that are used by Windows and illumos system networks. These naming services include the following:</para><listitem><para><emphasis role="strong">Active Directory Service (AD).</emphasis> AD is a Windows directory service that is integrated with the <firstterm>Domain Name System (DNS)</firstterm>. AD runs only on domain controllers. In addition to storing and making data available, AD protects network objects from unauthorized access and replicates objects across a network so that data is not lost if one domain controller fails.</para>
</listitem><listitem><para><emphasis role="strong">Domain Name System (DNS).</emphasis> DNS resolves host names to Internet Protocol (IP) addresses for the system. This service enables you to identify a server by either its IP address or its name.</para>
</listitem><listitem><para><emphasis role="strong">Dynamic DNS (DDNS).</emphasis> DDNS is provided with AD and enables a client to dynamically update its entries in the DNS database.</para>
</listitem><listitem><para><emphasis role="strong">Lightweight Data Access Protocol (LDAP).</emphasis> LDAP is a standard, extensible directory access protocol that enables clients and servers that use LDAP naming services to communicate with each other.</para>
</listitem><listitem><para><emphasis role="strong">Network Information Service (NIS).</emphasis> NIS is a naming service that focuses on making network administration more manageable by providing centralized control over a variety of network information. NIS stores information about the network, machine names and addresses, users, and network services.</para>
</listitem><listitem><para><emphasis role="strong">Network Time Protocol (NTP).</emphasis> NTP is a protocol that enables a client to automatically synchronize its system clock with a time server. The clock is synchronized each time the client is booted and any time it contacts the time server.</para>
</listitem>
</itemizedlist>
</sect1><sect1 xml:id="smbshares"><title>SMB Shares</title><para>A shared resource, or <firstterm>share</firstterm>, is a local resource on a server that is accessible to SMB clients on the network. For the illumos SMB service, a share is typically a directory. Each share is identified by a name on the network. An SMB client sees the share as a complete entity on the SMB server, and does not see the local directory path to the share on the server.</para><note><para>A share and a directory are independent entities. Removing a share does not affect the underlying directory.</para>
</note><para>Shares are commonly used to provide network access to home directories on a network file server. Each user is assigned a home directory. A share is persistent and remains defined regardless of whether users are connected to the server.</para><para>The illumos SMB service provides a special kind of share called an autohome SMB share. An <firstterm>autohome share</firstterm> is a transient share of a user's home directory that is created when a user logs in and removed when the user logs out.</para><para>When a user browses the system, only statically defined shares and his autohome share will be listed.</para><sect2 xml:id="autohomeshares"><title>Autohome Shares</title><para>The autohome share feature eliminates the administrative task of defining and maintaining home directory shares for each user that accesses the system through the SMB protocol. The system creates autohome shares when a user logs in, and removes them when the user logs out. This process reduces the administrative effort needed to maintain user accounts, and increases the efficiency of service resources.</para><para>For example, if <filename>/home</filename> is a home directory that contains subdirectories for users <literal>bob</literal> and <literal>sally</literal>, you can manually define the shares as follows:</para><variablelist termlength="medium"><varlistentry><term><literal>bob</literal></term><listitem><para><filename>/home/bob</filename></para>
</listitem>
</varlistentry><varlistentry><term><literal>sally</literal></term><listitem><para><filename>/home/sally</filename></para>
</listitem>
</varlistentry>
</variablelist><para>However, defining and maintaining directory shares in this way for each user is inconvenient. Instead, you can use the autohome feature.</para><note><para>The illumos SMB client does not support autohome shares.</para>
</note><para>To configure the autohome feature, you need to specify autohome share rules. For example, if a user's home directory is <filename>/fort/sally</filename>, the autohome path is <filename>/fort</filename>. The temporary share is named <filename>sally</filename>. Note that the user's home directory name must be the same as the user's login name. See <xref linkend="createspecificautohomeshareruletask"/>.</para><para>When a user logs in, the illumos SMB service looks for a subdirectory that matches the user's name based on any rules that have been specified. If the service finds a match and if that share does not already exist, the subdirectory is added as a transient share. When the user logs out, the service removes that transient share.</para><para>Some Windows clients log a user out after 15 minutes of inactivity, which results in the autohome share disappearing from the list of defined shares. This behavior is expected for SMB autohome shares. Even after an SMB autohome share is removed, the share reappears when the user attempts to access the system (for example, in an Explorer window).</para><note><para>All autohome shares are removed when the illumos SMB service is restarted.</para>
</note><sect3 xml:id="autohomeentries"><title>Autohome Entries</title><para>The illumos SMB service can automatically share home directories when an SMB client connects. The autohome map file, <filename>/etc/smbautohome</filename>, uses the search options and rules to determine whether to share a home directory when an SMB client connects to the service.</para><para>For example, the following entries specify the autohome rules for a particular environment:</para><screen>+nsswitch	    dn=ads,dn=sun,dn=com,ou=users
jane    /home/?/&amp;    dn=ads,dn=sun,dn=com,ou=users</screen><para>The <literal>nsswitch</literal> autohome entry uses the naming service to match users to home directories. The second autohome entry specifies that the home directory for user <literal>jane</literal> is <filename>/home/j/jane</filename>.</para><sect4 xml:id="autohomemapentryformat"><title>Autohome Map Entry Format</title><para>A map entry, also referred to as a mapping, uses the following format:</para><screen><replaceable>key</replaceable> <replaceable>location</replaceable> [ <replaceable>container</replaceable> ]</screen><para><replaceable>key</replaceable> is a user name, <replaceable>location</replaceable> is the fully qualified path for the user's home directory, and <replaceable>container</replaceable> is an optional AD container.</para><para>If you intend to publish the share in AD, you <emphasis>must</emphasis> specify an AD container name, which is specified as a comma-separated list of attribute name-value pairs. The attributes use the <firstterm>Lightweight Data Access Protocol (LDAP)</firstterm> distinguished name (DN) or relative distinguished name (RDN) format.</para><itemizedlist><para>The DN or RDN must be specified in LDAP format by using the following attribute types:</para><listitem><para><literal>cn=</literal> represents the common name</para>
</listitem><listitem><para><literal>ou=</literal> represents the organizational unit</para>
</listitem><listitem><para><literal>dc=</literal> represents the domain component</para>
</listitem>
</itemizedlist><note><para>The attribute type that is used to describe an object's RDN is called a <emphasis>naming attribute</emphasis>.</para><itemizedlist><para>AD uses the naming attributes as follows:</para><listitem><para><literal>cn</literal> for the <classname>user</classname> object
class</para>
</listitem><listitem><para><literal>ou</literal> for the <classname>OU</classname> (organizational unit) object class</para>
</listitem><listitem><para><literal>dc</literal> for the <classname>domainDns</classname> object class</para>
</listitem>
</itemizedlist>
</note>
</sect4><sect4 xml:id="autohomemapkeysubs"><title>Autohome Map Key Substitution</title><itemizedlist><para>The autohome feature supports the following wildcard substitutions for the value of the key field:</para><listitem><para>The ampersand character (<literal>&amp;</literal>) is expanded to the value of the key field for the entry in which it occurs. In the following example, <literal>&amp;</literal> expands to <literal>jane</literal>:</para><programlisting>jane /home/&amp;</programlisting>
</listitem><listitem><para>The question mark character (<literal>?</literal>) is expanded to the value of the first character in the key field for the entry in which it occurs. In the following example, the path is expanded to <filename>/home/jj/jane</filename>:</para><programlisting>jane /home/??/&amp;</programlisting>
</listitem>
</itemizedlist>
</sect4><sect4 xml:id="wildcardrule"><title>Wildcard Rule</title><para>When supplied in the key field, the asterisk character (<literal>*</literal>) is recognized as the &ldquo;catch-all&rdquo; entry. Such an entry matches any key not previously matched.</para><para>For example, the following entry would map any user to a home directory in <filename>/home</filename> in which the home directory name was the same as the user name:</para><programlisting>*    /home/&amp;</programlisting><note><para>The wildcard rule is <emphasis>only</emphasis> applied if an appropriate rule is not matched by another map entry.</para>
</note>
</sect4><sect4 xml:id="nsswitchmap"><title><filename>nsswitch</filename> Map</title><para>The <filename>nsswitch</filename> map is used to request that the home directory be obtained from a password database, such as the local, NIS, or LDAP database. If an AD path is appended, it is used to publish shares.</para><programlisting>+nsswitch</programlisting><para>Like the &ldquo;catch-all&rdquo; entry, the <literal>nsswitch</literal> map is <emphasis>only</emphasis> searched if an appropriate rule is not matched by another map entry.</para><note><para>The wildcard and <literal>nsswitch</literal> rules are mutually exclusive. Do not include an <literal>nsswitch</literal> rule if a wildcard rule has already been defined.</para>
</note>
</sect4>
</sect3>
</sect2>
</sect1><sect1 xml:id="localsmbgroupsusers"><title>Local SMB Groups</title><para>Local SMB groups can be created on the system that runs the illumos SMB service. These SMB groups apply only to users that are connected through SMB.</para><itemizedlist><para>The illumos SMB service supports the following built-in SMB groups:</para><listitem><para><emphasis role="strong">Administrators.</emphasis> Members of this group can fully administer files and directories on the system.</para>
</listitem><listitem><para><emphasis role="strong">Backup Operators.</emphasis> Members of this group can bypass file security to back up and restore files.</para>
</listitem><listitem><para><emphasis role="strong">Power Users.</emphasis> Members of this group can be assigned ownership of files and directories on the system, and can back up and restore files.</para>
</listitem>
</itemizedlist><para>Local groups use privileges to provide a secure mechanism for assigning task responsibility on a system-wide basis. Each privilege has a well-defined role assigned by the system administrator to a user or a group.</para><para>Unlike access rights (which are assigned as permissions on a per-object basis through security descriptors), privileges are independent of objects. Privileges bypass object-based access control lists to allow the holder of the privilege to perform the role assigned. For example, members of the Backup Operators group must be able to bypass normal security checks to back up and restore files they would normally not be able to access.</para><itemizedlist><para>The following definitions show the difference between an access right and a privilege:</para><listitem><para>An <emphasis>access right</emphasis> is explicitly granted or denied to a user or a group. Access rights are assigned as permissions in a discretionary access control list (DACL) on a per-object basis.</para>
</listitem><listitem><para>A <emphasis>privilege</emphasis> is a system-wide role that implicitly grants members of a group the ability to perform predefined operations. Privileges override or bypass object-level access rights.</para>
</listitem>
</itemizedlist><para>You can assign any of the privileges to any of the local groups. Because you can make any domain user a member of the local groups, you can assign these privileges to any domain user.</para><itemizedlist><para>The following privileges are supported for local groups:</para><listitem><para><emphasis role="strong">Back up files and directories.</emphasis> Perform backups without requiring read access permission on the target files and folders.</para>
</listitem><listitem><para><emphasis role="strong">Restore files and directories.</emphasis> Restore files without requiring write access permission on the target files and folders.</para>
</listitem><listitem><para><emphasis role="strong">Take ownership of files and folders.</emphasis> Take ownership of an object without requiring take-ownership access permission. Ownership can only be set to those values that the holder of the privilege may legitimately assign to an object.</para>
</listitem>
</itemizedlist><para>By default, members of the local Administrators group can take ownership of any file or folder, and members of the Backup Operators group can perform backup and restore operations. Members of the Power Users group do not have default privileges.</para><para>For information about managing SMB groups, see <xref linkend="managingsmbgroupsuserstm"/>.</para>
</sect1>
</chapter>
